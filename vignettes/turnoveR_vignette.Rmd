---
title: "turnoveR: Data Processing"
author: "Corinne Walsh"
output:
  html_document:
    df_print: paged
---


```{r message = FALSE, warning = FALSE}
library(readxl)
library(readr)
library(dplyr)
library(plotly)
library(purrr)
devtools::load_all(".")
```

## Introduction to turnoveR

With the original goal of quantifying protein turnover and protein degradation for as many proteins as possible in a proteome, the turnoveR package has been developed to analyse isotopically labeled proteomics datasets. 

Experimental datasets intended for use with this package are generated from a series of samples taken from a steady-state bacterial culture. Samples are taken at different timepoints following an isotopic label "pulse".  

Functions in the turnoveR package accept mass spectrometry datasets that have been pre-processed to estimate areas of the "heavy" and "light" isotopic labeled fractions for each protein (by programs such as Massacre). 


## Data Input
###Input File Types accepted

#### "protein_sums.csv": 
 - a file containing a sum of how many times each protein was identified in each sample of a dataset 
 - Preferred file type: .csv 
 - Important column names: 

#### "svm_results.csv": 
 - typically a massacre output file curated to remove poorly fitted curves 
 - Preferred file type: .csv 
 - Important column names: 
 
#### "metadata.xlsx": 
 - an excel sheet with sample timepoints, other sampling information 
 - Preferred file type: .xlsx 
 - Important column names: 


## Functions

###Data processing
General data processing functions

tor_read_svm_data_file - Read SVM data file

tor_rename_proteins - Rename proteins based on protein mapping file

tor_filter_peptides_by_spectral_fit - Process the SVM data

###Calculation functions
Functions to perform calculations on protein turnover data

tor_calculate_degradation_dissipation - Calculate degradation rate

tor_calculate_label_rate - Calculate protein or peptide labeling rate

tor_calculate_labeled_fraction - Calculate labeled fraction

###Visualization functions
Functions to visualize the data

tor_plot_label_rate_error - plot label rate error

tor_plot_label_rate_hist - Plot label rate histogram

tor_plot_labeling_curves - plot disippation curves

## Example: Data Processing 

###Reading in Files
```{r message = FALSE, warning = FALSE}

svm_data <- tor_read_svm_data_file(file.path("vignette_data", "svm_pred_results_0.03gr.csv"))

metadata <- read_excel(file.path("vignette_data", "metadata_CMW.xlsx"))

psms <- read_csv(file.path("vignette_data", "psms.csv"))

prot_rename_filepath <- file.path("vignette_data", "rename_prot.xlsx")
```

###Calculate Fraction of Labeled Proteins
```{r}
svm_data_filtered <- 
  svm_data %>% 
  tor_rename_proteins(prot_rename_filepath) %>% 
  tor_filter_peptides_by_spectral_fit(pred_cutoff = 0.75) %>% 
  tor_calculate_labeled_fraction() %>% 
  # adjust names 
  select(unishort = uniShort, protein = prot, gene, isopep = seqz, sample, frac_ulab, frac_lab) %>% 
 # add timepoints from metadata
  left_join(metadata, by = "sample")
```

###Calculate Degradation and Dissipation rates 
```{r}
#Important: need vessel volume and flow rate for growth_rate calculation
growth_rate = 0.46*60 /894.4 
generation_time = log(2) / growth_rate


final_data <- tor_calculate_label_rate(svm_data_filtered, quiet = FALSE) %>%
  #filter out data with bad fits, or not enough data points 
  filter(enough_data, !fit_error) %>% 
  select(-enough_data, -fit_error) %>% 
  
  tor_calculate_degradation_dissipation(growth_rate) 
  
  #add psms information to create weighted calculations
final_table <- final_data %>% 
  left_join(psms, by = "protein") %>% 
  mutate(
    relative_abundance =  (T0_counts / sum(T0_counts, na.rm = TRUE)),
    weighted_deg = deg_rate * relative_abundance,
    weighted_disp = dissipation * relative_abundance
  ) %>% 
  
  #rename columns - need to make sure column names are consistent
  rename(protein_count = T0_counts) %>% 
  select(-nested_data, -fit)
```


### Degradation Analysis - Looking at data

```{r}
#sum turnover rate for experiment 
sum_dissipation = sum(final_table$weighted_disp, na.rm = TRUE) 
sum_dissipation

#list top proteins by label rate 
label_top50 = top_n(final_table, n = 50, wt = final_table$label_rate)
label_top50

#list top proteins by relative abundance
relative_abundance_top50 = top_n(final_table, n = 50, wt = final_table$relative_abundance)
relative_abundance_top50

#list top proteins by weighted degradation
weighted_degradation_top50 = top_n(final_table, n = 50, wt = final_table$weighted_deg)
weighted_degradation_top50
```


###Data Quality Visualizations

```{r}
tor_plot_label_rate_hist(final_data)
tor_plot_label_rate_error(final_data)
tor_plot_labeling_curves(final_data, plot_number = 2)
```

