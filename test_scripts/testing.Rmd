---
title: "Testing the file read"
output: html_document
---

```{r setup}
library(tidyverse)
library(stringr)
```


```{r}
devtools::load_all(".")
filepath <- file.path("tests", "testthat", "test_data", "svm_pred_results.csv")
svm_data <- read_svm_data_file(filepath)
```



```{r}
svm_data %>% 
  process_svm_data(pred_cutoff = 0.75) %>% 
  mutate(
    frac_ulab = ampU / (ampU + ampL),
    frac_lab = 1-frac_ulab
  ) %>% 
  left_join(meta_data, by = "sample") %>% 
  select(unishort = uniShort, protein = prot, gene, isopep = seqz, sample, frac_lab) %>% 
  arrange(sample, protein) %>% 
  spread(sample, frac_lab, fill = 0)
```



```{r}
meta_data <- readxl::read_excel(file.path("test_scripts", "metadata.xlsx"))

processed_data <- svm_data %>% 
  process_svm_data(pred_cutoff = 0.75) %>% 
  rename(unishort = uniShort, protein = prot, isopep = seqz) %>% 
  mutate(
    frac_ulab = ampU / (ampU + ampL),
    frac_lab = 1-frac_ulab
  ) %>% 
  left_join(meta_data, by = "sample") %>% 
  group_by(protein, isopep) %>%
  # calculate the number of time points where the peptide is identified
  mutate(
    n_time_points_identified = n()
  ) %>% ungroup() %>% 
  # filter out the ones that are not present in enough time points
  filter(n_time_points_identified > 3)
```


```{r}
processed_data %>% 
  filter(prot %in% unique(prot)[1:10]) %>% 
  ggplot() +
  aes(hours - min(hours), frac_lab, color = prot, shape = replicate, size = svmPred) +
  geom_point() +
  theme(legend.position="none") +
  facet_wrap(~prot)
#library(plotly)
#ggplotly()
```

